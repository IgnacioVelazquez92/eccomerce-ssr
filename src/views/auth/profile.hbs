{{!-- views/auth/profile.hbs --}}
{{!-- ----------------------------------------------------------------------------
Vista: Perfil de Usuario (todo en una sola pantalla)
Responsabilidad
- Mostrar datos básicos del usuario (no editables aquí: name, email, rol, activo).
- Editar teléfono de contacto.
- Gestionar direcciones de envío (listar, marcar preferida, eliminar, agregar).
UX
- Bootstrap 5 puro, enfoque en claridad (sin estilos custom).
Dependencias/Contratos
- El servidor debe pasar `user` con:
• user.name, user.email, user.role, user.active, user.createdAt
• user.phone
• user.addresses[] (subdocs con { _id, label, line1, line2?, city, state, zip })
• user.defaultAddressId
- Helpers HBS necesarios: `eq` y `dateTime`.
Rutas (ver routes/account.js):
GET /account/profile
POST /account/profile/phone
POST /account/profile/addresses
POST /account/profile/addresses/:id/default
POST /account/profile/addresses/:id/delete
---------------------------------------------------------------------------- --}}
{{#> layouts/main title="Mi perfil" }}

<div class="container py-4">
    <div class="row">
        <div class="col-12 col-lg-5 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-4">
                    <h5 class="mb-3">Información de cuenta</h5>
                    <table class="table table-sm mb-3">
                        <tbody>
                            <tr>
                                <th class="w-25">Nombre</th>
                                <td>{{user.name}}</td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td>{{user.email}}</td>
                            </tr>
                            <tr>
                                <th>Rol</th>
                                <td>
                                    {{user.role}}
                                    {{#if user.isAdmin}}
                                    <span class="badge text-bg-secondary ms-1">admin</span>
                                    {{/if}}
                                </td>
                            </tr>
                            <tr>
                                <th>Activo</th>
                                <td>{{#if user.active}}Sí{{else}}No{{/if}}</td>
                            </tr>
                            <tr>
                                <th>Creado</th>
                                <td>{{dateTime user.createdAt}}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="d-flex gap-2">
                        <a href="/" class="btn btn-outline-secondary">Volver al inicio</a>
                        <a href="/logout" class="btn btn-outline-danger">Cerrar sesión</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-7 mb-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <h5 class="mb-3">Teléfono de contacto</h5>
                    <form class="row row-cols-lg-auto g-2 align-items-center" method="POST"
                        action="/account/profile/phone" novalidate>
                        <div class="col-12 flex-grow-1">
                            <label for="phone" class="visually-hidden">Teléfono</label>
                            <input id="phone" type="text" name="phone" class="form-control"
                                placeholder="Ej. 381-5555555" value="{{user.phone}}" />
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                    <p class="text-muted small mb-0 mt-2">
                        Este número se usará para coordinar la entrega o contactar ante dudas.
                    </p>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Direcciones de envío</h5>
                    </div>

                    {{#if user.addresses.length}}
                    <div class="table-responsive mb-4">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th class="w-15">Etiqueta</th>
                                    <th>Dirección</th>
                                    <th class="w-15">Ciudad</th>
                                    <th class="w-15">Provincia</th>
                                    <th class="w-10">CP</th>
                                    <th class="w-10">Preferida</th>
                                    <th class="text-end w-25">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each user.addresses}}
                                <tr>
                                    <td>{{this.label}}</td>
                                    <td>
                                        {{this.line1}}
                                        {{#if this.line2}} - {{this.line2}}{{/if}}
                                    </td>
                                    <td>{{this.city}}</td>
                                    <td>{{this.state}}</td>
                                    <td>{{this.zip}}</td>
                                    <td>
                                        {{#if (eq ../user.defaultAddressId this._id)}}
                                        <span class="badge text-bg-success">Sí</span>
                                        {{else}}
                                        <span class="badge text-bg-secondary">No</span>
                                        {{/if}}
                                    </td>
                                    <td class="text-end">
                                        {{#unless (eq ../user.defaultAddressId this._id)}}
                                        <form method="POST" action="/account/profile/addresses/{{this._id}}/default"
                                            class="d-inline">
                                            <button class="btn btn-sm btn-outline-primary">Marcar preferida</button>
                                        </form>
                                        {{/unless}}
                                        <form method="POST" action="/account/profile/addresses/{{this._id}}/delete"
                                            class="d-inline ms-1">
                                            <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                                        </form>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                    {{else}}
                    <div class="alert alert-info">
                        Aún no agregaste direcciones. Completá el formulario para añadir tu primera dirección.
                    </div>
                    {{/if}}

                    <hr class="my-3">

                    <h6 class="mb-3">Agregar nueva dirección</h6>
                    <form method="POST" action="/account/profile/addresses" novalidate>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="label" class="form-label">Etiqueta (opcional)</label>
                                <input id="label" type="text" name="label" class="form-control"
                                    placeholder="Casa / Trabajo" />
                            </div>
                            <div class="col-md-8">
                                <label for="line1" class="form-label">Calle y número</label>
                                <input id="line1" type="text" name="line1" class="form-control" required />
                            </div>
                            <div class="col-md-4">
                                <label for="line2" class="form-label">Piso / Dto (opcional)</label>
                                <input id="line2" type="text" name="line2" class="form-control" />
                            </div>
                            <div class="col-md-3">
                                <label for="city" class="form-label">Ciudad</label>
                                <input id="city" type="text" name="city" class="form-control" required />
                            </div>
                            <div class="col-md-3">
                                <label for="state" class="form-label">Provincia</label>
                                <input id="state" type="text" name="state" class="form-control" required />
                            </div>
                            <div class="col-md-2">
                                <label for="zip" class="form-label">Código Postal</label>
                                <input id="zip" type="text" name="zip" class="form-control" required />
                            </div>
                            <div class="col-12">
                                <button class="btn btn-success">Agregar dirección</button>
                            </div>
                        </div>
                    </form>

                    <p class="text-muted small mt-3 mb-0">
                        La primera dirección agregada se marcará automáticamente como preferida.
                        Podés cambiar la preferida desde el listado.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{{/layouts/main}}